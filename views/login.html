{% extends "base.html" %}

{% block title %}
登录
{% endblock title %}

{% block script %}
<script>
    "use strict";
    $("#register_btn").click(function () {
        $("#register_form").css("display", "block");
        $("#login_form").css("display", "none");
        $("#reset_form").css("display", "none");
        $(".text-danger").remove();
        $("input[type!='button']").val("");
        $("#register_account").focus();
    });

    $("#back_btn").click(function () {
        $("#register_form").css("display", "none");
        $("#login_form").css("display", "block");
        $("#reset_form").css("display", "none");
        $(".text-danger").remove();
        $("input[type!='button']").val("");
        $("#login_account").focus();
    });

    $("#forget").click(function () {
        $("#register_form").css("display", "none");
        $("#login_form").css("display", "none");
        $("#reset_form").css("display", "block");
        $(".text-danger").remove();
        $("input[type!='button']").val("");
        $("#reset_account").focus();
    });

    $("#login").click(function (event) {
            event.preventDefault();
            login()
        }
    );

    $("#sign_up").click(function (event) {
            event.preventDefault();
            register()
        }
    );

    $("#reset_btn").click(function (event) {
        event.preventDefault();
        reset_account()
    });

    function login() {
        var account = $("#login_account").val();
        var password = $("#login_password").val();
        var remember = $(".checkbox").children().is(':checked');
        $(".text-danger").remove();
        if (emailVerification(account) && password.length >= 5) {
            $.ajax({
                url: "/api/v1/user/login",
                type: "post",
                dataType: "json",
                data: JSON.stringify({ "account": account, "password": password, "remember": remember }),
                headers: { 'Content-Type': 'application/json' },
                success: function (res) {
                    if (res.status) {
                        window.location = "/"
                    } else {
                        if (res.error === "NotFound") {
                            $("#login").prev().before("<span class='text-danger'>用户被锁定或未创建</span>")
                        } else {
                            $("#login").prev().before("<span class='text-danger'>用户名或密码错误</span>")
                        }
                    }
                }
            })
        } else {
            $("#login").prev().before("<span class='text-danger'>Email无效或密码小于5位</span>")
        }
    }

    function register() {
        var account = $("#register_account").val();
        var password = $("#register_password").val();
        var nickname = $("#nickname").val();
        $(".text-danger").remove();
        if (emailVerification(account) && password.length >= 5 && nickname !== "") {
            $.ajax({
                url: "/api/v1/user/sign_up",
                type: "post",
                dataType: "json",
                data: JSON.stringify({ "account": account, "password": password, "nickname": nickname }),
                headers: { "Content-Type": "application/json" },
                success: function (res) {
                    if (res.status) {
                        window.location = "/"
                    } else {
                        $("#sign_up").prev().before("<span class='text-danger'>用户已创建</span>")
                    }
                }
            })
        } else {
            $("#sign_up").prev().before("<span class='text-danger'>Email无效或密码小于5位</span>")
        }
    }

    function reset_account() {
        var account = $("#reset_account").val();
        $(".text-danger").remove();
        if (account !== "") {
            $.ajax({
                url: "/api/v1/user/reset_pwd",
                type: "post",
                dataType: "json",
                data: JSON.stringify({ "account": account }),
                headers: { "Content-Type": "application/json" },
                success: function (res) {
                    if (res.status) {
                        window.location = "/"
                    } else {
                        $("#reset_btn").prev().before("<span class='text-danger'>用户不存在</span>")
                    }
                }
            })
        } else {
            $("#reset_btn").prev().before("<span class='text-danger'>account 不能为空</span>")
        }
    }

    function emailVerification(email) {
        var reg_email = /^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;
        return reg_email.test(email);
    }
</script>
{% endblock script %}

{% block content %}
<style>
    #login_form {
        display: block;
    }

    #register_form {
        display: none;
    }

    #reset_form {
        display: none;
    }

    a:hover {
        text-decoration: none;
        cursor: pointer;
    }

    a {
        color: -webkit-link;
        text-decoration: underline;
        cursor: auto;
    }

    .text-danger {
        color: red
    }
</style>

<div id="login_form">
    <b>Login</b>
    <br>
    <br>
    <form>
        <table border="0">
            <tbody>
            <tr>
                <td>account:</td>
                <td><input type="text" name="account" value="" size="20" autofocus="autofocus" placeholder="Email" id="login_account"></td>
                <td><strong>Please fill in the real and effective email address</strong></td>
            </tr>
            <tr>
                <td>password:</td>
                <td><input type="password" name="password" value="" size="20" placeholder="Password" id="login_password"></td>
            </tr>
            <label class="checkbox">
                <input type="checkbox" name="remember"/> Remember 90 day
            </label>
            </tbody>
        </table>
        <br>
        <input type="button" class="btn btn-success pull-right" id="login" value="Login "/>
    </form>
    <br/>
    <a id="forget">Forgot your password?</a><br/>
    <a id="register_btn" class="">Create an account</a>

    <br>
    <br>
</div>
<div id="register_form">
    <b>Create Account</b>
    <br>
    <br>
    <form>
        <table border="0">
            <tbody>
            <tr>
                <td>account:</td>
                <td><input type="text" name="acct" value="" size="20" placeholder="Email" id="register_account"></td>
            </tr>
            <tr>
                <td>password:</td>
                <td><input type="password" name="pw" value="" size="20" id="register_password"></td>
            </tr>
            <tr>
                <td>nickname:</td>
                <td><input type="text" id="nickname" class="required"></td>
            </tr>
            </tbody>
        </table>
        <br>
        <input type="button" id="sign_up" value="Sign up "/>
        <input type="button" id="back_btn" value="Back"/>
    </form>
    <br>
    <br>
</div>
<div id="reset_form">
    <b>Reset your password</b>
    <br>
    <br>
    <form>
        <table border="0">
            <tbody>
            <tr>
                <td>account:</td>
                <td><input type="text" name="acct" value="" size="20" placeholder="Email" id="reset_account"></td>
            </tr>
            </tbody>
        </table>
        <br>
        <input type="button" id="reset_btn" value="reset"/>
    </form>
    <br>
    <br>
</div>
{% endblock content %}
